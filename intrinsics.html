<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.75">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="The Intrinsics part of a camera model that transforms points to.from the">

<title>mvgutils - Intrinsics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: 1;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="mvgutils - Intrinsics">
<meta property="og:description" content="The Intrinsics part of a camera model that transforms points to.from the">
<meta property="og:site-name" content="mvgutils">
<meta name="twitter:title" content="mvgutils - Intrinsics">
<meta name="twitter:description" content="The Intrinsics part of a camera model that transforms points to.from the">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">mvgutils</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/srippa/mvgutils/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Intrinsics</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Install</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./plane3d.html" class="sidebar-item-text sidebar-link">plane3D</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./plot3d.html" class="sidebar-item-text sidebar-link">plot3d</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intrinsics.html" class="sidebar-item-text sidebar-link active">Intrinsics</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#geometric-camera-model" id="toc-geometric-camera-model" class="nav-link active" data-scroll-target="#geometric-camera-model">Geometric camera model</a>
  <ul>
  <li><a href="#from_homogeneous" id="toc-from_homogeneous" class="nav-link" data-scroll-target="#from_homogeneous">from_homogeneous</a></li>
  <li><a href="#to_homogeneous" id="toc-to_homogeneous" class="nav-link" data-scroll-target="#to_homogeneous">to_homogeneous</a></li>
  <li><a href="#intrinsics" id="toc-intrinsics" class="nav-link" data-scroll-target="#intrinsics">Intrinsics</a></li>
  </ul></li>
  <li><a href="#intrinsics-api" id="toc-intrinsics-api" class="nav-link" data-scroll-target="#intrinsics-api">Intrinsics API</a>
  <ul>
  <li><a href="#supported-camera-models" id="toc-supported-camera-models" class="nav-link" data-scroll-target="#supported-camera-models">Supported camera models</a></li>
  <li><a href="#construct-camera-model" id="toc-construct-camera-model" class="nav-link" data-scroll-target="#construct-camera-model">Construct camera model</a>
  <ul class="collapse">
  <li><a href="#initialization" id="toc-initialization" class="nav-link" data-scroll-target="#initialization">Initialization</a></li>
  <li><a href="#intrinsics.from_opencv_model" id="toc-intrinsics.from_opencv_model" class="nav-link" data-scroll-target="#intrinsics.from_opencv_model">Intrinsics.from_opencv_model</a></li>
  <li><a href="#intrinsics.from_opencv_fisheye_model" id="toc-intrinsics.from_opencv_fisheye_model" class="nav-link" data-scroll-target="#intrinsics.from_opencv_fisheye_model">Intrinsics.from_opencv_fisheye_model</a></li>
  <li><a href="#intrinsics.from_pinhole_model" id="toc-intrinsics.from_pinhole_model" class="nav-link" data-scroll-target="#intrinsics.from_pinhole_model">Intrinsics.from_pinhole_model</a></li>
  <li><a href="#intrinsics.from_test_model" id="toc-intrinsics.from_test_model" class="nav-link" data-scroll-target="#intrinsics.from_test_model">Intrinsics.from_test_model</a></li>
  </ul></li>
  <li><a href="#access-functions" id="toc-access-functions" class="nav-link" data-scroll-target="#access-functions">Access functions</a>
  <ul class="collapse">
  <li><a href="#intrinsics.k" id="toc-intrinsics.k" class="nav-link" data-scroll-target="#intrinsics.k">Intrinsics.K</a></li>
  <li><a href="#intrinsics.k_inv" id="toc-intrinsics.k_inv" class="nav-link" data-scroll-target="#intrinsics.k_inv">Intrinsics.K_inv</a></li>
  <li><a href="#intrinsics.k_3" id="toc-intrinsics.k_3" class="nav-link" data-scroll-target="#intrinsics.k_3">Intrinsics.K_3</a></li>
  <li><a href="#intrinsics.k_3_inv" id="toc-intrinsics.k_3_inv" class="nav-link" data-scroll-target="#intrinsics.k_3_inv">Intrinsics.K_3_inv</a></li>
  <li><a href="#intrinsics.distortions" id="toc-intrinsics.distortions" class="nav-link" data-scroll-target="#intrinsics.distortions">Intrinsics.distortions</a></li>
  <li><a href="#intrinsics.params" id="toc-intrinsics.params" class="nav-link" data-scroll-target="#intrinsics.params">Intrinsics.params</a></li>
  <li><a href="#intrinsics.get_fov" id="toc-intrinsics.get_fov" class="nav-link" data-scroll-target="#intrinsics.get_fov">Intrinsics.get_fov</a></li>
  </ul></li>
  <li><a href="#transformations" id="toc-transformations" class="nav-link" data-scroll-target="#transformations">Transformations</a>
  <ul class="collapse">
  <li><a href="#intrinsics.scale" id="toc-intrinsics.scale" class="nav-link" data-scroll-target="#intrinsics.scale">Intrinsics.scale</a></li>
  <li><a href="#intrinsics.resize" id="toc-intrinsics.resize" class="nav-link" data-scroll-target="#intrinsics.resize">Intrinsics.resize</a></li>
  <li><a href="#intrinsics.crop" id="toc-intrinsics.crop" class="nav-link" data-scroll-target="#intrinsics.crop">Intrinsics.crop</a></li>
  </ul></li>
  <li><a href="#image-undistortion" id="toc-image-undistortion" class="nav-link" data-scroll-target="#image-undistortion">Image undistortion</a>
  <ul class="collapse">
  <li><a href="#intrinsics.get_undistort_camera" id="toc-intrinsics.get_undistort_camera" class="nav-link" data-scroll-target="#intrinsics.get_undistort_camera">Intrinsics.get_undistort_camera</a></li>
  <li><a href="#intrinsics.init_undistort_rectify_map" id="toc-intrinsics.init_undistort_rectify_map" class="nav-link" data-scroll-target="#intrinsics.init_undistort_rectify_map">Intrinsics.init_undistort_rectify_map</a></li>
  <li><a href="#intrinsics.undistort_image" id="toc-intrinsics.undistort_image" class="nav-link" data-scroll-target="#intrinsics.undistort_image">Intrinsics.undistort_image</a></li>
  </ul></li>
  <li><a href="#project-and-unproject-points" id="toc-project-and-unproject-points" class="nav-link" data-scroll-target="#project-and-unproject-points">Project and unproject points</a>
  <ul class="collapse">
  <li><a href="#project-points" id="toc-project-points" class="nav-link" data-scroll-target="#project-points">Project points</a></li>
  <li><a href="#intrinsics.camera2image_points" id="toc-intrinsics.camera2image_points" class="nav-link" data-scroll-target="#intrinsics.camera2image_points">Intrinsics.camera2image_points</a></li>
  <li><a href="#intrinsics.project_points" id="toc-intrinsics.project_points" class="nav-link" data-scroll-target="#intrinsics.project_points">Intrinsics.project_points</a></li>
  <li><a href="#intrinsics.distort_points" id="toc-intrinsics.distort_points" class="nav-link" data-scroll-target="#intrinsics.distort_points">Intrinsics.distort_points</a></li>
  <li><a href="#intrinsics.project_and_distort_points" id="toc-intrinsics.project_and_distort_points" class="nav-link" data-scroll-target="#intrinsics.project_and_distort_points">Intrinsics.project_and_distort_points</a></li>
  <li><a href="#intrinsics.to_image_points" id="toc-intrinsics.to_image_points" class="nav-link" data-scroll-target="#intrinsics.to_image_points">Intrinsics.to_image_points</a>
  <ul class="collapse">
  <li><a href="#unproject-points" id="toc-unproject-points" class="nav-link" data-scroll-target="#unproject-points">Unproject points</a></li>
  </ul></li>
  <li><a href="#intrinsics.to_camera_points" id="toc-intrinsics.to_camera_points" class="nav-link" data-scroll-target="#intrinsics.to_camera_points">Intrinsics.to_camera_points</a></li>
  <li><a href="#intrinsics.undistort_points" id="toc-intrinsics.undistort_points" class="nav-link" data-scroll-target="#intrinsics.undistort_points">Intrinsics.undistort_points</a>
  <ul class="collapse">
  <li><a href="#tests" id="toc-tests" class="nav-link" data-scroll-target="#tests">Tests</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/srippa/mvgutils/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Intrinsics</h1>
</div>

<div>
  <div class="description">
    The Intrinsics part of a camera model that transforms points to.from the
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="geometric-camera-model" class="level1">
<h1>Geometric camera model</h1>
<p>The class <a href="https://srippa.github.io/mvgutils/intrinsics.html#intrinsics"><code>Intrinsics</code></a> models a pinhole camera with distortions. Useful books are:</p>
<ul>
<li>The book <a href="http://szeliski.org/Book/">Computer Vision: Algorithms and Applications, 2nd ed.</a>, <a href="https://szeliski.org/RichardSzeliski.htm">Richard Szeliski</a>, 2022 that can be freely downloaded.</li>
<li><a href="https://www.robots.ox.ac.uk/~vgg/hzbook/">Multiple View Geometry in Computer Vision, 2nd ed.</a>, Hartley and Zisserman, , Cambridge University Press, 2004</li>
<li><a href="https://www.eecis.udel.edu/~cer/arv/readings/old_mkss.pdf">An Invitation to 3-D Vision (pdf)</a>, Yi Ma, Jana Koˇseck´a, Stefano Soatto, Shankar Sastry, 2001</li>
</ul>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsicts.py#L43" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="from_homogeneous" class="level3">
<h3 class="anchored" data-anchor-id="from_homogeneous">from_homogeneous</h3>
<blockquote class="blockquote">
<pre><code> from_homogeneous (points)</code></pre>
</blockquote>
<p>Remove the homogeneous dimension of N-dimensional points. Args: points: torch.Tensor or numpy.ndarray with size (…, N+1). Returns: A torch.Tensor or numpy ndarray with size (…, N).</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsicts.py#L25" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="to_homogeneous" class="level3">
<h3 class="anchored" data-anchor-id="to_homogeneous">to_homogeneous</h3>
<blockquote class="blockquote">
<pre><code> to_homogeneous (points)</code></pre>
</blockquote>
<p>Convert N-dimensional points to homogeneous coordinates. Args: points: torch.Tensor or numpy.ndarray with size (…, N). Returns: A torch.Tensor or numpy.ndarray with size (…, N+1).</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#L56" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics">Intrinsics</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics (camera_model_name:str, width:int, height:int, params:list)</code></pre>
</blockquote>
<p>Camera intrinsic model</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>camera_model_name</td>
<td>str</td>
<td>One of the keys in SUPPORTED_CAMERA_MODELS</td>
</tr>
<tr class="even">
<td>width</td>
<td>int</td>
<td>width of the image in pixels</td>
</tr>
<tr class="odd">
<td>height</td>
<td>int</td>
<td>height of the image in pixels</td>
</tr>
<tr class="even">
<td>params</td>
<td>list</td>
<td>parameters, in COLMAP conventions</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="intrinsics-api" class="level1">
<h1>Intrinsics API</h1>
<section id="supported-camera-models" class="level2">
<h2 class="anchored" data-anchor-id="supported-camera-models">Supported camera models</h2>
<p>This is the list of all supported camera models. Each item includes tha name of the camera model, e.g.&nbsp;<code>SIMPLE_RADIAL</code> and list of expected parameters as handled by <a href="https://srippa.github.io/mvgutils/intrinsics.html#intrinsics"><code>Intrinsics</code></a>. All camera models of <a href="https://github.com/colmap/colmap/blob/master/src/base/camera_models.h">COLMAP</a> are supported and some more, as needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Intrinsics.supported_camera_models()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of supported camera models and their parameters
_______________________________________________________
SIMPLE_PINHOLE      : f, cx, cy
PINHOLE             : fx, fy, cx, cy
SIMPLE_RADIAL       : f, cx, cy, k
RADIAL              : f, cx, cy, k1, k2
OPENCV              : fx, fy, cx, cy, k1, k2, p1, p2
OPENCV_FISHEYE      : fx, fy, cx, cy, k1, k2, k3, k4
FULL_OPENCV         : fx, fy, cx, cy, k1, k2, p1, p2, k3, k4, k5, k6
FOV                 : fx, fy, cx, cy, omega
OPENCV5             : fx, fy, cx, cy, k1, k2, p1, p2, k3
UNKNOWN             : []</code></pre>
</div>
</div>
</section>
<section id="construct-camera-model" class="level2">
<h2 class="anchored" data-anchor-id="construct-camera-model">Construct camera model</h2>
<section id="initialization" class="level4">
<h4 class="anchored" data-anchor-id="initialization">Initialization</h4>
<p>Call to the constructor of the class with parameters such as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Intrinsics(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    camera_model_name<span class="op">=</span><span class="st">'OPENCV5'</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">640</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">320</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>[<span class="dv">400</span>, <span class="fl">410.0</span>, <span class="dv">320</span>, <span class="dv">160</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">228</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(640, 320)
  params: [400.0, 410.0, 320.0, 160.0, 14.0, 15.0, 16.0, 17.0, 228.0]
  cx,cy= (320.0,160.0)
  fx,fy= (400.0,410.0)
  distortions: [ 14.  15.  16.  17. 228.]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.from_opencv_model" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.from_opencv_model">Intrinsics.from_opencv_model</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.from_opencv_model (K:numpy.ndarray, distortions:numpy.ndarray,
                               width:int, height:int)</code></pre>
</blockquote>
<p>Contructing camera intrinsics model from opencv compatible data</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>K</td>
<td>ndarray</td>
<td>3x3 camera matrix</td>
</tr>
<tr class="even">
<td>distortions</td>
<td>ndarray</td>
<td>distortion array as produced by OpenCv</td>
</tr>
<tr class="odd">
<td>width</td>
<td>int</td>
<td>Camera width in pixels</td>
</tr>
<tr class="even">
<td>height</td>
<td>int</td>
<td>Camera height in pixels</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.from_opencv_fisheye_model" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.from_opencv_fisheye_model">Intrinsics.from_opencv_fisheye_model</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.from_opencv_fisheye_model (K:numpy.ndarray,
                                       distortions:numpy.ndarray,
                                       width:int, height:int)</code></pre>
</blockquote>
<p>Contructing camera intrinsics model from data compatible with opencv fisheye model</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>K</td>
<td>ndarray</td>
<td>3x3 camera matrix</td>
</tr>
<tr class="even">
<td>distortions</td>
<td>ndarray</td>
<td>distortion array for OpenCv fisheye model, should consist of 4 distrortion parameters</td>
</tr>
<tr class="odd">
<td>width</td>
<td>int</td>
<td>Camera width in pixels</td>
</tr>
<tr class="even">
<td>height</td>
<td>int</td>
<td>Camera height in pixels</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.from_pinhole_model" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.from_pinhole_model">Intrinsics.from_pinhole_model</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.from_pinhole_model (fx:float, fy:float, cx:float, cy:float,
                                width:int, height:int)</code></pre>
</blockquote>
<p>Contructing camera intrinsics model from opencv compatible data</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fx</td>
<td>float</td>
<td>Focal length (x) in pixels</td>
</tr>
<tr class="even">
<td>fy</td>
<td>float</td>
<td>Focal length (y) in pixels. fy might be equal to fx (SIMPLE_PINHOLE model) or different (PINHOLE model)</td>
</tr>
<tr class="odd">
<td>cx</td>
<td>float</td>
<td>Camera center (x) in pixels</td>
</tr>
<tr class="even">
<td>cy</td>
<td>float</td>
<td>Camera center (y) in pixels</td>
</tr>
<tr class="odd">
<td>width</td>
<td>int</td>
<td>Image width in pixels</td>
</tr>
<tr class="even">
<td>height</td>
<td>int</td>
<td>Image height in pixels</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>As an example, consider the construction from an OpenCv model with 5 parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">1280</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">720</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>fx <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fy <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>cx <span class="op">=</span> <span class="dv">1280</span> <span class="op">/</span><span class="dv">2</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>cy <span class="op">=</span> <span class="dv">720</span> <span class="op">/</span><span class="dv">2</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> np.array(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        [fx, <span class="fl">0.0</span>, cx],</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.0</span>, fy, cy],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.0</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>distortions <span class="op">=</span> [<span class="op">-</span><span class="fl">1.51960304e-01</span>,  <span class="fl">5.60700273e-01</span>, <span class="op">-</span><span class="fl">1.28234990e-02</span>,  <span class="fl">1.41775450e-03</span>, <span class="fl">5.23404322e+00</span>]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>Intrinsics.from_opencv_model(K,distortions,width, height)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(1280, 720)
  params: [600.0, 600.0, 640.0, 360.0, -0.151960304, 0.560700273, -0.012823499, 0.0014177545, 5.23404322]
  cx,cy= (640.0,360.0)
  fx,fy= (600.0,600.0)
  distortions: [-1.51960304e-01  5.60700273e-01 -1.28234990e-02  1.41775450e-03
  5.23404322e+00]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.from_test_model" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.from_test_model">Intrinsics.from_test_model</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.from_test_model (as_full_opencv=False)</code></pre>
</blockquote>
<p>Contructing camera intrinsics model from opencv calibration tutorial</p>
<p>The test model is taken form the <a href="https://docs.opencv.org/3.3.0/dc/dbb/tutorial_py_calibration.html">OpenCV calibration tutorial</a> and the images used for calibrating the test model are given in <a href="https://github.com/opencv/opencv/tree/master/samples/data">this directory</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>Intrinsics.from_test_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(640, 480)
  params: [535.915733961632, 535.915733961632, 342.28315473308373, 235.57082909788173, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (342.28315473308373,235.57082909788173)
  fx,fy= (535.915733961632,535.915733961632)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]</code></pre>
</div>
</div>
</section>
</section>
<section id="access-functions" class="level2">
<h2 class="anchored" data-anchor-id="access-functions">Access functions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Camera : </span><span class="sc">{</span>c<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">, fx=</span><span class="sc">{</span>c<span class="sc">.</span>fx<span class="sc">}</span><span class="ss">, fy=</span><span class="sc">{</span>c<span class="sc">.</span>fy<span class="sc">}</span><span class="ss">, cx=</span><span class="sc">{</span>c<span class="sc">.</span>cx<span class="sc">}</span><span class="ss">, cy=</span><span class="sc">{</span>c<span class="sc">.</span>cy<span class="sc">}</span><span class="ss">, distortions=</span><span class="sc">{</span>c<span class="sc">.</span>distortions<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Camera width: </span><span class="sc">{</span>c<span class="sc">.</span>w<span class="sc">}</span><span class="ss">, heigth: </span><span class="sc">{</span>c<span class="sc">.</span>h<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Camera : OPENCV5, fx=400.0, fy=410.0, cx=320.0, cy=160.0, distortions=[ 14.  15.  16.  17. 228.]
Camera width: 640, heigth: 320</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="intrinsics.k" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.k">Intrinsics.K</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.K ()</code></pre>
</blockquote>
<p>Return the 4x4 camera matrix in homogenous coordinates</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.k_inv" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.k_inv">Intrinsics.K_inv</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.K_inv ()</code></pre>
</blockquote>
<p>Return the 4x4 inverse of camera matrix in homogenous coordinates</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.k_3" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.k_3">Intrinsics.K_3</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.K_3 ()</code></pre>
</blockquote>
<p>Return the 3x3 camera matrix in npn homogenous coordinates</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.k_3_inv" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.k_3_inv">Intrinsics.K_3_inv</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.K_3_inv ()</code></pre>
</blockquote>
<p>Return the 3x3 inverse of the camera matrix in npn homogenous coordinates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Homogenous camera matrix: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>c<span class="sc">.</span>K<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>c<span class="sc">.</span>K<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Non homogenous camera matrix: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>c<span class="sc">.</span>K_3<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Homogenous camera matrix: 
 [[400.   0. 320.   0.]
 [  0. 410. 160.   0.]
 [  0.   0.   1.   0.]
 [  0.   0.   0.   1.]], float64
Non homogenous camera matrix: 
 [[400.   0. 320.]
 [  0. 410. 160.]
 [  0.   0.   1.]]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.distortions" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.distortions">Intrinsics.distortions</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.distortions ()</code></pre>
</blockquote>
<p>Returns 1D distortion array</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Distortions: </span><span class="sc">{</span>c<span class="sc">.</span>distortions<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>c<span class="sc">.</span>distortions<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distortions: [ 14.  15.  16.  17. 228.], float64</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.params" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.params">Intrinsics.params</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.params ()</code></pre>
</blockquote>
<p>Get list of parametes as expected in the consrtructor for the given camera model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Parameters of camera model </span><span class="sc">{</span>c<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>c<span class="sc">.</span>params<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameters of camera model OPENCV5: [400.0, 410.0, 320.0, 160.0, 14.0, 15.0, 16.0, 17.0, 228.0]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.get_fov" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.get_fov">Intrinsics.get_fov</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.get_fov ()</code></pre>
</blockquote>
<p>Get horizontal and vertical field of view of the canera, in degrees</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>Intrinsics.from_test_model().get_fov()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'fovx': 61.683594005974356, 'fovy': 48.248686484809355}</code></pre>
</div>
</div>
</section>
</section>
<section id="transformations" class="level2">
<h2 class="anchored" data-anchor-id="transformations">Transformations</h2>
<p>Transformations such as <code>scale</code> or <code>crop</code> effect also the camera model. We need to update the camera model to be cosistent with the scaled/cropped image.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>base_camera <span class="op">=</span> Intrinsics.from_test_model()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>base_camera</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(640, 480)
  params: [535.915733961632, 535.915733961632, 342.28315473308373, 235.57082909788173, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (342.28315473308373,235.57082909788173)
  fx,fy= (535.915733961632,535.915733961632)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="intrinsics.scale" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.scale">Intrinsics.scale</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.scale (scale_by:Tuple)</code></pre>
</blockquote>
<p>Update Intrinsicss after scaling an image</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>scale_by</td>
<td>Tuple</td>
<td>Sacle factors as (scale_width, scale_height)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td><strong>Intrinsics for camera producing the scaled image</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>base_camera.scale((<span class="fl">0.5</span>,<span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(320, 240)
  params: [267.957866980816, 267.957866980816, 171.14157736654187, 117.78541454894086, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (171.14157736654187,117.78541454894086)
  fx,fy= (267.957866980816,267.957866980816)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.resize" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.resize">Intrinsics.resize</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.resize (new_size:Tuple)</code></pre>
</blockquote>
<p>Update Intrinsicss after resizing an image</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>new_size</td>
<td>Tuple</td>
<td>New size as (new_width, new_height)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td><strong>Intrinsics for the camera producing the resized image</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>base_camera.resize((<span class="dv">240</span>,<span class="dv">240</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(240, 240)
  params: [200.968400235612, 267.957866980816, 128.3561830249064, 117.78541454894086, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (128.3561830249064,117.78541454894086)
  fx,fy= (200.968400235612,267.957866980816)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.crop" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.crop">Intrinsics.crop</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.crop (top_left:Tuple[float], crop_size:Tuple[int])</code></pre>
</blockquote>
<p>Update Intrinsicss after cropping an image</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>top_left</td>
<td>Tuple</td>
<td>Top left pixel of cropped image as (x,y)</td>
</tr>
<tr class="even">
<td>crop_size</td>
<td>Tuple</td>
<td>Size of cropped bbox (size_x, size_y)</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td><strong>Intrinsics for the camera producing the cropped image</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>base_camera.crop(top_left<span class="op">=</span>(<span class="dv">100</span>,<span class="dv">100</span>), crop_size<span class="op">=</span>(<span class="dv">200</span>,<span class="dv">200</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Camera: OPENCV5
  w,h=(200, 200)
  params: [535.915733961632, 535.915733961632, 242.28315473308373, 135.57082909788173, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (242.28315473308373,135.57082909788173)
  fx,fy= (535.915733961632,535.915733961632)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]</code></pre>
</div>
</div>
</section>
</section>
<section id="image-undistortion" class="level2">
<h2 class="anchored" data-anchor-id="image-undistortion">Image undistortion</h2>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="intrinsics.get_undistort_camera" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.get_undistort_camera">Intrinsics.get_undistort_camera</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.get_undistort_camera (alpha:float)</code></pre>
</blockquote>
<p>Update Intrinsicss for camera producing the undistorted image/points</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>alpha</td>
<td>float</td>
<td>A number between 0 (all pixels in the undistorted image are valid) and 1 (all source images are retained but there are some black pixels)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Intrinsics</strong></td>
<td><strong>A PINHOLE camera model that corresponds to the undistorted image</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>base_camera <span class="op">=</span> Intrinsics.from_test_model().scale((<span class="fl">0.5</span>,<span class="fl">0.5</span>))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(base_camera)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Comparing impelementation of get_undistort_camera to OpenCv getOptimalNewCameraMatrix for different values of alpha'</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>mtx <span class="op">=</span> base_camera.K_3</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>errors_K <span class="op">=</span> []</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> [<span class="fl">0.0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>]:</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    new_matrix_cv, roi <span class="op">=</span> cv2.getOptimalNewCameraMatrix(</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        base_camera.K_3,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        base_camera.distortions,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        (base_camera.w,base_camera.h),</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(roi)</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    new_camera <span class="op">=</span> base_camera.get_undistort_camera(alpha<span class="op">=</span>alpha)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    err_new_matrix <span class="op">=</span> np.linalg.norm(new_camera.K_3<span class="op">-</span>new_matrix_cv)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    errors_K.append(err_new_matrix)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.<span class="bu">any</span>(np.array(errors_K) <span class="op">&lt;</span> <span class="fl">0.002</span>), <span class="ss">f'Large errors between OpenCV and "get_undistort_camera": [</span><span class="sc">{</span>errors_K<span class="sc">}</span><span class="ss">]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Camera: OPENCV5
  w,h=(320, 240)
  params: [267.957866980816, 267.957866980816, 171.14157736654187, 117.78541454894086, -0.2663726090966068, -0.03858889892230465, 0.0017831947042852964, -0.0002812210044111547, 0.23839153080878486]
  cx,cy= (171.14157736654187,117.78541454894086)
  fx,fy= (267.957866980816,267.957866980816)
  distortions: [-0.26637261 -0.0385889   0.00178319 -0.00028122  0.23839153]

Comparing impelementation of get_undistort_camera to OpenCv getOptimalNewCameraMatrix for different values of alpha</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.init_undistort_rectify_map" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.init_undistort_rectify_map">Intrinsics.init_undistort_rectify_map</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.init_undistort_rectify_map (alpha)</code></pre>
</blockquote>
<p>Return parameters needed for image undistortion plut the PINHOLE camera model of the undistorted image</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>alpha</td>
<td></td>
<td>A number between 0 (all pixels in the undistorted image are valid) and 1 (all source images are retained but there are some black pixels)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>EasyDict</strong></td>
<td><strong>dict with entries: “pinhole_camera”, “mapx”, “mapy” consisting of all infor needed to undistort an image</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> [<span class="fl">0.0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>]:</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> base_camera.init_undistort_rectify_map(alpha<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    opencv_mapx, opencv_mapy <span class="op">=</span> cv2.initUndistortRectifyMap(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        base_camera.K_3, </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        base_camera.distortions,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">None</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        r.pinhole_camera.K_3,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        (r.pinhole_camera.w,r.pinhole_camera.h),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        cv2.CV_32FC1</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    ex <span class="op">=</span> np.linalg.norm(r.mapx<span class="op">-</span>opencv_mapx)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    ey <span class="op">=</span> np.linalg.norm(r.mapy<span class="op">-</span>opencv_mapy)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> ex <span class="op">&lt;</span> <span class="fl">0.01</span>, <span class="ss">f'Assertion error (alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">): Errors: mapx_opencv-mapx=</span><span class="sc">{</span>ex<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> ey <span class="op">&lt;</span> <span class="fl">0.01</span>, <span class="ss">f'Assertion error (alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">): Errors: mapy_opencv-mapy=</span><span class="sc">{</span>ey<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the results of <code>init_undistort_rectify_map</code> we can now undistort images. The undistorted image correspond to the PINHOLE camera model.</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.undistort_image" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.undistort_image">Intrinsics.undistort_image</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.undistort_image (img:numpy.ndarray,
                             undistorted_info:easydict.EasyDict)</code></pre>
</blockquote>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>img</td>
<td>ndarray</td>
<td>Input image</td>
</tr>
<tr class="even">
<td>undistorted_info</td>
<td>EasyDict</td>
<td>The output from ‘init_undistort_rectify_map’</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>undistorted image</strong></td>
</tr>
</tbody>
</table>
<p>In the following examples we will undistort an images, given a calibrated camera. The camera parameters and the images taken from the <a href="https://github.com/opencv/opencv/tree/master/samples/data">data directory</a> used by the <a href="https://docs.opencv.org/3.3.0/dc/dbb/tutorial_py_calibration.html">OpenCV calibration tutorial</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ci <span class="op">=</span> Intrinsics.from_test_model()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Distorted image: camera-model=</span><span class="sc">{</span>ci<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">: fx=</span><span class="sc">{</span>ci<span class="sc">.</span>fx<span class="sc">}</span><span class="ss">, fy=</span><span class="sc">{</span>ci<span class="sc">.</span>fy<span class="sc">}</span><span class="ss">, cx=</span><span class="sc">{</span>ci<span class="sc">.</span>cx<span class="sc">}</span><span class="ss">, cy=</span><span class="sc">{</span>ci<span class="sc">.</span>cy<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>root_dir <span class="op">=</span> Path(os.getcwd())</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">str</span>(root_dir) <span class="kw">not</span> <span class="kw">in</span> sys.path:</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    sys.path.insert(<span class="dv">0</span>,<span class="bu">str</span>(root_dir))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>img_dir <span class="op">=</span> root_dir <span class="op">/</span> <span class="st">'data'</span> </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>img_file <span class="op">=</span> img_dir <span class="op">/</span> <span class="st">'left03.jpg'</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>cv_img <span class="op">=</span> cv2.imread(<span class="bu">str</span>(img_file))</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>cv_img <span class="op">=</span> cv2.cvtColor(cv_img, cv2.COLOR_BGR2RGB)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>pil_img <span class="op">=</span> Image.fromarray(cv_img)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>display(pil_img)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distorted image: camera-model=OPENCV5: fx=535.915733961632, fy=535.915733961632, cx=342.28315473308373, cy=235.57082909788173</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_intrinsics_files/figure-html/cell-37-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>With <code>alpha=1.0</code> all original pixels of the distorted image are kept also in the undistorted version. The drawback is that we now many black pixels in the perimeter of the image.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> ci.init_undistort_rectify_map(alpha<span class="op">=</span>alpha)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>cp <span class="op">=</span> r.pinhole_camera</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Undistrted image (alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">): camera-model=</span><span class="sc">{</span>cp<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">: fx=</span><span class="sc">{</span>cp<span class="sc">.</span>fx<span class="sc">}</span><span class="ss">, fy=</span><span class="sc">{</span>cp<span class="sc">.</span>fy<span class="sc">}</span><span class="ss">, cx=</span><span class="sc">{</span>cp<span class="sc">.</span>cx<span class="sc">}</span><span class="ss">, cy=</span><span class="sc">{</span>cp<span class="sc">.</span>cy<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>img_undistorted <span class="op">=</span> Intrinsics.undistort_image(cv_img, r)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>im_pil_u <span class="op">=</span> Image.fromarray(img_undistorted)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>display(im_pil_u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Undistrted image (alpha=1.0): camera-model=PINHOLE: fx=467.88845379768406, fy=468.28742729330503, cx=341.4258283195987, cy=236.2097112614839</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_intrinsics_files/figure-html/cell-38-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>With <code>alpha=0.0</code> value, we have no black pixels but some pixels of the original image are lost.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> ci.init_undistort_rectify_map(alpha<span class="op">=</span>alpha)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>cp <span class="op">=</span> r.pinhole_camera</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Undistrted image (alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">): camera-model=</span><span class="sc">{</span>cp<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">: fx=</span><span class="sc">{</span>cp<span class="sc">.</span>fx<span class="sc">}</span><span class="ss">, fy=</span><span class="sc">{</span>cp<span class="sc">.</span>fy<span class="sc">}</span><span class="ss">, cx=</span><span class="sc">{</span>cp<span class="sc">.</span>cx<span class="sc">}</span><span class="ss">, cy=</span><span class="sc">{</span>cp<span class="sc">.</span>cy<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>img_undistorted <span class="op">=</span> Intrinsics.undistort_image(cv_img, r)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>im_pil_u <span class="op">=</span> Image.fromarray(img_undistorted)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>display(im_pil_u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Undistrted image (alpha=0.0): camera-model=PINHOLE: fx=478.9090531962673, fy=502.669315116053, cx=345.568809503914, cy=235.2218688743195</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_intrinsics_files/figure-html/cell-39-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>It is, of course, posible to change <code>alpha</code> between 0 and 1 to control the tradeoff between number of black pixels and number of pixels in the distorted image that are lost.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.4</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> ci.init_undistort_rectify_map(alpha<span class="op">=</span>alpha)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>cp <span class="op">=</span> r.pinhole_camera</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Undistrted image (alpha=</span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss">): camera-model=</span><span class="sc">{</span>cp<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">: fx=</span><span class="sc">{</span>cp<span class="sc">.</span>fx<span class="sc">}</span><span class="ss">, fy=</span><span class="sc">{</span>cp<span class="sc">.</span>fy<span class="sc">}</span><span class="ss">, cx=</span><span class="sc">{</span>cp<span class="sc">.</span>cx<span class="sc">}</span><span class="ss">, cy=</span><span class="sc">{</span>cp<span class="sc">.</span>cy<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>img_undistorted <span class="op">=</span> Intrinsics.undistort_image(cv_img, r)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>im_pil_u <span class="op">=</span> Image.fromarray(img_undistorted)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>display(im_pil_u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Undistrted image (alpha=0.4): camera-model=PINHOLE: fx=474.50081343683405, fy=488.91655998695376, cx=343.91161703018787, cy=235.61700582918527</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="03_intrinsics_files/figure-html/cell-40-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="project-and-unproject-points" class="level2">
<h2 class="anchored" data-anchor-id="project-and-unproject-points">Project and unproject points</h2>
<p>Points are represented in <code>homogenous</code> coordinates or in regular Eucledian coordinates. We will denote points in hompogenous coordinates with a <code>tilde</code> so a 3D point <span class="math inline">\(P\)</span> in homogenous coordinates will be denoted by <span class="math inline">\(\tilde{P}\)</span>. IN the same manner, 2D points will be written in small letters, such as <span class="math inline">\(\tilde{p}\)</span> in 2D homogenous coordinates and <span class="math inline">\(p\)</span> in 2D Eucledian space.</p>
<section id="project-points" class="level4">
<h4 class="anchored" data-anchor-id="project-points">Project points</h4>
<p>The function</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.camera2image_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.camera2image_points">Intrinsics.camera2image_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.camera2image_points (pc3d:numpy.ndarray)</code></pre>
</blockquote>
<p>Project 3D points in the camera reference coordinate system into image coordinates</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pc3d</td>
<td>ndarray</td>
<td>3D points in camera frame system with shape (N,3)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Tuple</strong></td>
<td><strong>A 2D point in the camera plane with shape (N,2), disparities with shape (N,1) and boolean valid mask with shape (N,)</strong></td>
</tr>
</tbody>
</table>
<p>In homegenous coordinates we have <span class="math display">\[
\tilde{p}_c = \begin{pmatrix} x_c \\ y_c \\ z_c \\1  \end{pmatrix}  \Rightarrow \tilde{p}_u = \begin{pmatrix} u \\ v \\ \tt{d}  \end{pmatrix}
\]</span> where <span class="math inline">\(\tilde{p}_c\)</span> is a 3D point in the camera coordinate system, <span class="math inline">\(\tilde{p}_u\)</span> consists of the pixel cooridates of that point, <code>d</code> is the disparity.</p>
<p>The function expects regular collection of 3D points as an array of shape (N,3) and returns:</p>
<ul>
<li>2D points in image plane, array of shape (N,2)</li>
<li>disparitiers (inverse depth), array of shape (N,2)</li>
<li>A <code>valid</code> boolean vector for indexing the valid points. 3D points for which <span class="math inline">\(z\)</span> is too close to zero are invalid</li>
</ul>
<p>We consider two sets of 3D points in the camera coordinate system. The first set of points, <code>pc3d</code>, contains four points that can be safely projected into the image plane while the second set <code>pc3d_z0</code> contains two invalid points, with <span class="math inline">\(z=0\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>ci <span class="op">=</span> Intrinsics.from_test_model()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>pc3d <span class="op">=</span>    np.array([[<span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">4.</span>], [<span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">2.0</span>], [<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>], [<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="fl">1.0</span>]])    <span class="co"># 4 valid points form projection</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>pc3d_z0 <span class="op">=</span> np.array([[<span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.</span>], [<span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">2.0</span>], [<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="dv">0</span>,], [<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="fl">1.0</span>]])    <span class="co"># 2 valid points in the set of 4 points</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Using camera model: </span><span class="sc">{</span>ci<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">, point sets with 4 3D points of shape: </span><span class="sc">{</span>pc3d<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using camera model: OPENCV5, point sets with 4 3D points of shape: (4, 3)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>pi__c2i, disparity__c2i, is_valid__c2i <span class="op">=</span> ci.camera2image_points(pc3d)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'pc3d: </span><span class="sc">{</span>pi__c2i<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> points in image plane, disparty: </span><span class="sc">{</span>disparity__c2i<span class="sc">.</span>squeeze()<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">,  is_valid: </span><span class="sc">{</span>is_valid__c2i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>pi_z0__c2i, disparity_z0__c2i, is_valid_z0__c2i <span class="op">=</span> ci.camera2image_points(pc3d_z0)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>pi_z0__c2i_good <span class="op">=</span> pi_z0__c2i[is_valid_z0__c2i,:]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>disparity_z0__c2i_good <span class="op">=</span> disparity_z0__c2i[is_valid_z0__c2i,:]</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'pc3d_z0: </span><span class="sc">{</span>pi_z0__c2i_good<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> good point in image plane, disparty: </span><span class="sc">{</span>disparity_z0__c2i_good<span class="sc">.</span>squeeze()<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">, is_valid: </span><span class="sc">{</span>is_valid_z0__c2i<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pc3d: 4 points in image plane, disparty: [0.25, 0.5, 0.6666666666666666, 1.0],  is_valid: [ True  True  True  True]
pc3d_z0: 2 good point in image plane, disparty: [0.5, 1.0], is_valid: [False  True False  True]</code></pre>
</div>
</div>
<p>The projection is divided into three separate operations: <code>project_points</code>, <code>distort_points</code> and <code>to_image_points</code>:</p>
<p>The function <code>project_points</code></p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.project_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.project_points">Intrinsics.project_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.project_points (pc3d:numpy.ndarray,
                            projection_type:str='perspective')</code></pre>
</blockquote>
<p>Project 3D points in camera frame to 2D points in the camera plane</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pc3d</td>
<td>ndarray</td>
<td></td>
<td>3D points in camera frame, with shape (N,3)</td>
</tr>
<tr class="even">
<td>projection_type</td>
<td>str</td>
<td>perspective</td>
<td>Projection type</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Tuple</strong></td>
<td></td>
<td><strong>A 2D point in the camera plane with shape (N,2), disparities with shape (N,1) and boolean valid mask with shape (N,)</strong></td>
</tr>
</tbody>
</table>
<p>Projections are covered in <a href="http://szeliski.org/Book/">Szeliski</a>, sec 2.1.4 in great detail. Currently we only support the perspective projection: <span class="math display">\[
\tilde{P}_c = \begin{pmatrix} x_c \\ y_c \\ z_c \\1  \end{pmatrix}  \Rightarrow \tilde{p}_c = \begin{pmatrix} x_c/z_c \\ y_c/z_c \\ 1  \end{pmatrix}
\]</span> The method <code>project_points</code> produces, in addition to the 2D points also the value of the <code>diaparity</code> (namely the inverse depth <span class="math inline">\(1/z\)</span>) and the last component returned is a boolean vector <code>valid</code> for indexing the cases where the transformation was valid, in particular when <span class="math inline">\(z\)</span> was not too close to zero.</p>
<p><strong>Example</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>p2_undistorted, disparity, is_valid <span class="op">=</span> ci.project_points(pc3d)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Points in camera plane of shape </span><span class="sc">{</span>p2_undistorted<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, disparty: </span><span class="sc">{</span>disparity<span class="sc">.</span>squeeze()<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">, is_valid: </span><span class="sc">{</span>is_valid<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.linalg.norm(disparity<span class="op">-</span>disparity__c2i) <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'Assetrion failed disparity from project_points [</span><span class="sc">{</span>disparity<span class="sc">}</span><span class="ss">] not equal to disparity from camera2image_points [</span><span class="sc">{</span>disparity__c2i<span class="sc">}</span><span class="ss">]'</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>p2d_z0, disparity_z0, is_valid_z0 <span class="op">=</span> ci.project_points(pc3d_z0)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>pi_z0__good <span class="op">=</span> p2d_z0[is_valid_z0,:]</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>disparity_z0_good <span class="op">=</span> disparity_z0[is_valid_z0,:]</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.linalg.norm(disparity_z0__c2i_good<span class="op">-</span>disparity_z0_good) <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'Assetrion failed: valid disparity produced by "project_points" [</span><span class="sc">{</span>disparity_z0_good<span class="sc">}</span><span class="ss">] not equal to valid disparity produced by camera2image_points [</span><span class="sc">{</span>disparity_z0__c2i_good<span class="sc">}</span><span class="ss">]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Points in camera plane of shape (4, 2), disparty: [0.25, 0.5, 0.6666666666666666, 1.0], is_valid: [ True  True  True  True]</code></pre>
</div>
</div>
<p>The <code>distort_points</code> function</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.distort_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.distort_points">Intrinsics.distort_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.distort_points (p_cam_undistorted:numpy.ndarray)</code></pre>
</blockquote>
<p>Distort points in the camera plane</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>p_cam_undistorted</td>
<td>ndarray</td>
<td>2D Undistorted point in the camera plane with shape (N,2)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>2D distorted point in the camera plane with shape (N,2)</strong></td>
</tr>
</tbody>
</table>
<p>using the distortion model as defined by the camera model: <span class="math display">\[
\tilde{p}_c = \begin{pmatrix} x_c/z_c \\ y_c/z_c \\ 1  \end{pmatrix} \Rightarrow p_d = \begin{pmatrix} x_d \\ y_d   \end{pmatrix}  = \tt{distorion\_function}(p_c)
\]</span> The camera models <code>PINHOLE</code> and <code>SIMPLE_PINHOLE</code> do not have distortions and then the distortion function reduces to the identity function. In all OpenCv compatible models we use the distortion function as described in <a href="https://learnopencv.com/understanding-lens-distortion/">Understanding Lens Distortion</a></p>
<p><strong>Example</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>p2_distorted <span class="op">=</span> ci.distort_points(p2_undistorted)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Points undistorted in camera plane of shape: </span><span class="sc">{</span>p2_undistorted<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, first point: </span><span class="sc">{</span>p2_undistorted[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Points distorted in camera plane of shape  : </span><span class="sc">{</span>p2_distorted<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, first_point: </span><span class="sc">{</span>p2_distorted[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Points undistorted in camera plane of shape: (4, 2), first point: [0.125 0.15 ]
Points distorted in camera plane of shape  : (4, 2), first_point: [0.12377257 0.14860793]</code></pre>
</div>
</div>
<p>It is always possible to join the <code>project_points</code> and <code>distort_points</code> into a single <code>project_and_distort_points</code> function.</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.project_and_distort_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.project_and_distort_points">Intrinsics.project_and_distort_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.project_and_distort_points (pc3d:numpy.ndarray)</code></pre>
</blockquote>
<p>Project 3D points in the camera reference coordinate system into 2D distorted points in the camera frame</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pc3d</td>
<td>ndarray</td>
<td>3D points in camera frame system with shape (N,3)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Tuple</strong></td>
<td><strong>A 2D point in the camera plane with shape (N,2), disparities with shape (N,1) and boolean valid mask with shape (N,)</strong></td>
</tr>
</tbody>
</table>
<p>For OpenCv camera model, exceept <code>OPENCV5</code>, that use the either the function <a href="https://docs.opencv.org/4.5.4/d9/d0c/group__calib3d.html#ga1019495a2c8d1743ed5cc23fa0daff8c">projectPoints</a> or the function <a href="https://docs.opencv.org/4.5.4/db/d58/group__calib3d__fisheye.html#gab1ad1dc30c42ee1a50ce570019baf2c4">fisheye.projectPoints</a> there is no way of calling to <code>project_points</code> and <code>distort_points</code> separatly so the only option is calling to <code>project_and_distort_points</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>ci_cv <span class="op">=</span> Intrinsics.from_test_model(as_full_opencv<span class="op">=</span><span class="va">True</span>)   <span class="co"># construct full OpenCv caera model</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'camera model: </span><span class="sc">{</span>ci<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>p2_distorted_cv, disparity_cv, is_valid_cv <span class="op">=</span> ci_cv.project_and_distort_points(pc3d)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Points in camera plane (project_and_distort_points): </span><span class="sc">{</span>p2_distorted_cv<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, disparty: </span><span class="sc">{</span>disparity_cv<span class="sc">.</span>squeeze()<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">, is_valid: </span><span class="sc">{</span>is_valid_cv<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>p2d_z0_cv, disparity_z0_cv, is_valid_z0_cv <span class="op">=</span> ci_cv.project_and_distort_points(pc3d_z0)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Good points in camera plane (project_and_distort_points): </span><span class="sc">{</span>p2d_z0_cv[is_valid_z0_cv]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, disparty: </span><span class="sc">{</span>disparity_z0_cv[is_valid_z0_cv]<span class="sc">.</span>squeeze()<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">, is_valid: </span><span class="sc">{</span>is_valid_z0_cv<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>camera model: OPENCV5
Points in camera plane (project_and_distort_points): (4, 2), disparty: [0.25, 0.5, 0.6666666666666666, 1.0], is_valid: [ True  True  True  True]
Good points in camera plane (project_and_distort_points): (2, 2), disparty: [0.5, 1.0], is_valid: [False  True False  True]</code></pre>
</div>
</div>
<p>For non OpenCv camera models the result of calling to <code>project_and_distort_points</code> to first calling to <code>project_points</code> and then calling to <code>distort_points</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>p2_distorted_1, disparity_1, valid_1 <span class="op">=</span> ci.project_and_distort_points(pc3d)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>err_p2u_project_and_distort_points <span class="op">=</span> np.linalg.norm(p2_distorted<span class="op">-</span>p2_distorted_1)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span>  err_p2u_project_and_distort_points <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'Assertion error. Error in results of "project_and_distort_points" vs  "project_points" and "distort_points" is too large: </span><span class="sc">{</span>err_p2u_project_and_distort_points<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>to_image_points</code></p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.to_image_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.to_image_points">Intrinsics.to_image_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.to_image_points (pc_distorted:numpy.ndarray)</code></pre>
</blockquote>
<p>Transform points from the camera plane to the image plane, using the camera matrix K</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pc_distorted</td>
<td>ndarray</td>
<td>2D points in the camera plane with shape (N,2)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>2D points in the image plane with shape (N,2)</strong></td>
</tr>
</tbody>
</table>
<p>In homogous coordinates the transformation is: <span class="math display">\[
\begin{pmatrix} u \\ v  \\ 1 \end{pmatrix} = \begin{pmatrix} f_x &amp; 0 &amp; c_x   \\  0 &amp; f_y &amp; c_y  \\ 0 &amp; 0 &amp; 1 \end{pmatrix} \begin{pmatrix} x_d \\ y_d  \\ 1 \end{pmatrix} = K \begin{pmatrix} x_d \\ y_d  \\ 1 \end{pmatrix}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>p_image <span class="op">=</span> ci.to_image_points(p2_distorted)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Shape of pixels points: </span><span class="sc">{</span>p_image<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, first point: </span><span class="sc">{</span>p_image[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of pixels points: (4, 2), first point: [408.61482149 315.21215808]</code></pre>
</div>
</div>
<section id="unproject-points" class="level4">
<h4 class="anchored" data-anchor-id="unproject-points">Unproject points</h4>
<p>The unprojection functions is about transforming back pixels into 3D points which is in general impossible, unless we know the <code>disparity</code></p>
<p>First we transform image pixels into tha camera plane:</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="intrinsics.to_camera_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.to_camera_points">Intrinsics.to_camera_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.to_camera_points (pu:numpy.ndarray)</code></pre>
</blockquote>
<p>Transform pixel image coordinates into the distorted camera plane</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pu</td>
<td>ndarray</td>
<td>points in the image plane, shape is (N,2)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>points in distorted camera plane, shape (N,2)</strong></td>
</tr>
</tbody>
</table>
<p>Namely <span class="math display">\[
\begin{pmatrix} x_d \\ y_d  \\ 1 \end{pmatrix}  = k^{-1} \begin{pmatrix} u \\ v  \\ 1 \end{pmatrix}
\]</span> where <span class="math display">\[
k^{-1} =  \begin{pmatrix} 1/f_x &amp; 0 &amp; -c_x/f_x   \\  0 &amp; 1/f_y &amp; -c_y/f_y  \\ 0 &amp; 0 &amp; 1 \end{pmatrix}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>p2_distorted_back_projected <span class="op">=</span> ci.to_camera_points(p_image)   <span class="co"># transform form image plane to distorted camera plane</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>err_distortion_backprojection_1 <span class="op">=</span> np.linalg.norm(p2_distorted_back_projected<span class="op">-</span>p2_distorted)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_distortion_backprojection_1 <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'Assertion failed error of unptojection to camera plane [</span><span class="sc">{</span>err_distortion_backprojection_1<span class="sc">}</span><span class="ss">] is too large'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step is to undistort the points in the image plane.</p>
<hr>
<p><a href="https://github.com/srippa/mvgutils/blob/main/mvgutils/intrinsics.py#LNone" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intrinsics.undistort_points" class="level3">
<h3 class="anchored" data-anchor-id="intrinsics.undistort_points">Intrinsics.undistort_points</h3>
<blockquote class="blockquote">
<pre><code> Intrinsics.undistort_points (pc_distorted:numpy.ndarray)</code></pre>
</blockquote>
<p>Undistort points in the image plane using the inverse of the distortion model for that camera model</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pc_distorted</td>
<td>ndarray</td>
<td>Distorted points in the camera plane, shape (N,2)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ndarray</strong></td>
<td><strong>Undistorted points in the image plane</strong></td>
</tr>
</tbody>
</table>
<p>I most cases, this procedure involves solving a polynomial equation by Newton iterations. The procedure converges very fast, and we use the OpenCv conventions and restrict the number of iterations to 17.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>p2_undistorted_back_projected <span class="op">=</span> ci.undistort_points(p2_distorted_back_projected)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>err_undistortion_backprojection_1 <span class="op">=</span> np.linalg.norm(p2_undistorted_back_projected<span class="op">-</span>p2_undistorted)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_undistortion_backprojection_1 <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'Assertion failed error of unptojection to camera plane [</span><span class="sc">{</span>err_undistortion_backprojection_1<span class="sc">}</span><span class="ss">] is too large'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we convert from the undistorted camera plane to the 3D camera coordinate system</p>
<section id="tests" class="level4">
<h4 class="anchored" data-anchor-id="tests">Tests</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>ci <span class="op">=</span> Intrinsics.from_test_model()                         <span class="co"># OPENCV5</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>ci_cv <span class="op">=</span> Intrinsics.from_test_model(as_full_opencv<span class="op">=</span><span class="va">True</span>)   <span class="co"># same model as ci but defined as OPENCV modxel with last 3 distortion coeffs = 0</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'full cv camera model: </span><span class="sc">{</span>ci_cv<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Test camera of type  </span><span class="sc">{</span>ci<span class="sc">.</span>camera_model_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co"># twopoints</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>points_camera <span class="op">=</span> np.array(</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.5</span>, <span class="fl">0.5</span>,<span class="fl">1.</span>],</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">2.</span>],</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">1.4</span>]</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>p2d_cv, d_cv, is_valid_cv <span class="op">=</span> ci_cv.project_and_distort_points(points_camera)  <span class="co"># OPENCV5 model  not handled by OpenCv functions</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>p2d, d, is_valid <span class="op">=</span> ci.project_and_distort_points(points_camera)              <span class="co"># FULL_OPENCV model handled by OpenCv functions, same as OPENCV5 since last 3 distortion params are zero</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>err_pts <span class="op">=</span> np.linalg.norm(p2d_cv<span class="op">-</span>p2d)</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>err_d <span class="op">=</span> np.linalg.norm(d_cv<span class="op">-</span>d)</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_pts <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'assersion failed comparing project_and_distort_points points to OpenCv [</span><span class="sc">{</span>err_pts<span class="sc">}</span><span class="ss">]'</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_d <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'assersion failed comparing project_and_distort_points disparities to OpenCv [</span><span class="sc">{</span>err_d<span class="sc">}</span><span class="ss">]'</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Test 1 : camera2image_points model to OpenCv computation</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>pimage, disparity, valid <span class="op">=</span> ci.camera2image_points(points_camera)</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>no_rot <span class="op">=</span> np.array([[<span class="fl">0.0</span>], [<span class="fl">0.0</span>], [<span class="fl">0.0</span>]])</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>no_trans <span class="op">=</span> np.array([[<span class="fl">0.0</span>], [<span class="fl">0.0</span>], [<span class="fl">0.0</span>]])</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>pimage_cv, _ <span class="op">=</span>  cv2.projectPoints(points_camera,                              <span class="co"># project to image</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>                           no_rot,</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>                           no_trans,</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>                           ci.K_3,</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>                           ci.distortions)</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>pimage_cv <span class="op">=</span> pimage_cv.squeeze(<span class="dv">1</span>)</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a><span class="co"># compare mvgutils to output of OpenCv</span></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>err_test_1 <span class="op">=</span> np.linalg.norm(pimage_cv<span class="op">-</span>pimage)</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_test_1 <span class="op">&lt;</span> <span class="fl">1e-5</span>,  <span class="ss">f'assersion failed distance between and OpenCV is too large [</span><span class="sc">{</span>err_test_1<span class="sc">}</span><span class="ss">]'</span></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Test 2 : transform from camera pixels to distgorted camera plane and then undistort</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>pd <span class="op">=</span> ci.to_camera_points(pimage)</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>pu <span class="op">=</span> ci.undistort_points(pd)</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>ppp <span class="op">=</span> np.expand_dims(pimage,<span class="dv">1</span>)</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>cv_undistorted <span class="op">=</span>  cv2.undistortPoints(ppp, ci.K_3, ci.distortions).squeeze()</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>err_test_2 <span class="op">=</span> np.linalg.norm(pu<span class="op">-</span>cv_undistorted)</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err_test_2 <span class="op">&lt;</span> <span class="fl">1e-5</span>, <span class="ss">f'assersion failed distance between and OpenCV is too large [</span><span class="sc">{</span>err_test_2<span class="sc">}</span><span class="ss">]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>full cv camera model: FULL_OPENCV
Test camera of type  OPENCV5</code></pre>
</div>
</div>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>